---
layout: vimdoc
helpname: 'usr_43'
---
<div id='vimCodeElement'>
<span class="MissingTag">usr_43.txt</span>&nbsp;&nbsp;&nbsp;&nbsp;For&nbsp;<span class="Identifier">Vim バージョン 8.1.</span>&nbsp;&nbsp;Last change: 2015 Oct 23<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; VIM USER MANUAL - by Bram Moolenaar<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ファイルタイプを使う<br>
<br>
<br>
C プログラムやシェルスクリプトなどの特定の種類のファイルを編集するときに、よく<br>
使うオプション設定やマップがあると思います。それを毎回手作業で設定するのは面倒<br>
ですよね。この章ではそれを自動化する方法を説明します。<br>
<br>
<span class="MissingTag">43.1</span>&nbsp;&nbsp;ファイルタイププラグイン<br>
<span class="MissingTag">43.2</span>&nbsp;&nbsp;ファイルタイプを追加する<br>
<br>
次章:&nbsp;<span class="MissingTag">usr_44.txt</span>&nbsp;&nbsp;構文ファイルを作成する<br>
前章:&nbsp;<span class="MissingTag">usr_42.txt</span>&nbsp;&nbsp;新しいメニューを追加する<br>
目次:&nbsp;<span class="MissingTag">usr_toc.txt</span><br>
<br>
<span class="PreProc">==============================================================================</span><br>
<span class="MissingTag">43.1</span>&nbsp;&nbsp;ファイルタイププラグイン&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="MissingTag">filetype-plugin</span><br>
<br>
ファイルタイププラグインの使用方法については既に&nbsp;<span class="MissingTag">add-filetype-plugin</span>&nbsp;で説明<br>
しました。しかし、標準では最小限の設定しかされないので、それだけでは物足りない<br>
と思います。例えば C ファイルを開いたときに、<span class="MissingTag">'softtabstop'</span>&nbsp;オプションを 4 に設<br>
定したり、三行コメントを挿入するためのマップを定義したりすると便利かもしれませ<br>
ん。2 ステップで設定できます。<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="MissingTag">your-runtime-dir</span><br>
1. 自分のランタイムディレクトリを作成する。Unix なら普通は &quot;~/.vim&quot; です。その<br>
&nbsp;&nbsp; ディレクトリの中に &quot;ftplugin&quot; ディレクトリを作成します:<br>
<br>
<div class="helpExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mkdir ~/.vim<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mkdir ~/.vim/ftplugin</div>
<br>
&nbsp;&nbsp; Unix 以外のシステムでは、<span class="MissingTag">'runtimepath'</span>&nbsp;オプションを見て、&quot;ftplugin&quot; ディレ<br>
&nbsp;&nbsp; クトリが検索される場所を確認してください:<br>
<br>
<div class="helpExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set runtimepath</div>
<br>
&nbsp;&nbsp;&nbsp;普通は最初のディレクトリ (最初のコンマの前) を使います。初期設定以外のディ<br>
&nbsp;&nbsp; レクトリを使いたい場合は、<span class="MissingTag">vimrc</span>&nbsp;ファイルの中で&nbsp;<span class="MissingTag">'runtimepath'</span>&nbsp;オプションを<br>
&nbsp;&nbsp; 設定してディレクトリを追加してください。<br>
<br>
2. &quot;~/.vim/ftplugin/c.vim&quot; を作成して設定を書きます:<br>
<br>
<div class="helpExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setlocal softtabstop=4<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;noremap &lt;buffer&gt; &lt;LocalLeader&gt;c o/**************&lt;CR&gt;&lt;CR&gt;/&lt;Esc&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;let b:undo_ftplugin = &quot;setl softtabstop&lt; | unmap &lt;buffer&gt; &lt;LocalLeader&gt;c&quot;</div>
<br>
そして、C ファイルを開いてみてください。<span class="MissingTag">'softtabstop'</span>&nbsp;オプションが 4 に設定さ<br>
れていますね。しかし、他のファイルを開くと初期設定の 0 にリセットされます。そ<br>
れは &quot;:setlocal&quot; コマンドが使われているからです。このコマンドはバッファの<br>
<span class="MissingTag">'softtabstop'</span>&nbsp;オプションだけを設定します。他のバッファを開くと、開いたバッファ<br>
用の設定が使用されます。新しいバッファの設定には、初期設定、または最後に<br>
&quot;:set&quot; コマンドで設定された値が使われます。<br>
<br>
同様に、&quot;\c&quot; マップも他のバッファを開くと見えなくなります。&quot;:map&nbsp;<span class="Special">&lt;buffer&gt;</span>&quot; コ<br>
マンドを使うと、カレントバッファの中だけで使えるマップを作成できます。これは<br>
&quot;:map!&quot; や &quot;:vmap&quot; などの他のマップコマンドでも同様です。マップの中の<br>
<span class="MissingTag">&lt;LocalLeader&gt;</span>&nbsp;は &quot;maplocalleader&quot; 変数の値で置き換えられます。<br>
<br>
b:undo_ftplugin を設定する行はファイルタイプを別の値に設定されていたときのため<br>
に用います。このケースではあなたが望む方法でundoしたいでしょう。<br>
b:undo_ftplugin 変数はコマンドとして実行されます。そのため中の文字は、バック<br>
スラッシュのように特別な意味を持つものがあるので、気をつけてください。<br>
<br>
ファイルタイププラグインの例はこのディレクトリで探すことができます:<br>
<br>
<div class="helpExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$VIMRUNTIME/ftplugin/</div>
<br>
ファイルタイププラグインの作成方法の詳細は&nbsp;<span class="MissingTag">write-plugin</span>&nbsp;を参照してください。<br>
<br>
<span class="PreProc">==============================================================================</span><br>
<span class="MissingTag">43.2</span>&nbsp;&nbsp;ファイルタイプを追加する<br>
<br>
Vim がファイルタイプを認識しない場合は、設定を追加してください。まず自分用のラ<br>
ンタイムディレクトリを用意する必要があります。上述の&nbsp;<span class="MissingTag">your-runtime-dir</span>&nbsp;を参照<br>
してください。<br>
<br>
&quot;filetype.vim&quot; というファイルを作成してファイルタイプ用の自動コマンドを設定し<br>
ます。(自動コマンドは&nbsp;<span class="MissingTag">40.3</span>&nbsp;で説明されています。) 例:<br>
<br>
<div class="helpExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;augroup filetypedetect<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;au BufNewFile,BufRead *.xyz&nbsp;&nbsp;&nbsp;&nbsp; setf xyz<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;augroup END</div>
<br>
ファイル名が &quot;.xyz&quot; で終わるすべてのファイルが &quot;xyz&quot; ファイルタイプとして認識<br>
されるようになります。&quot;:augroup&quot; コマンドを使って自動コマンドを<br>
&quot;filetypedetect&quot; グループに置いています。こうすることで、ファイルタイプを認識<br>
するための自動コマンドを &quot;:filetype off&quot; で削除できるようになります。&quot;setf&quot; コ<br>
マンドは&nbsp;<span class="MissingTag">'filetype'</span>&nbsp;を指定されたタイプに設定します。ただし、設定済みの場合は変<br>
更しません。これによってファイルタイプが二重に設定されないようになっています。<br>
<br>
ファイル名にマッチするパターンはいろいろなものが使えます。ディレクトリ名を含め<br>
ることもできます。<span class="MissingTag">autocmd-patterns</span>&nbsp;参照。例えば、&quot;/usr/share/scripts&quot; にある<br>
ファイルが拡張子に関係なくすべて &quot;ruby&quot; ファイルであるなら、次のような設定を追<br>
加します:<br>
<br>
<div class="helpExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;augroup filetypedetect<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;au BufNewFile,BufRead *.xyz&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; setf xyz<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;au BufNewFile,BufRead /usr/share/scripts/*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setf ruby<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;augroup END</div>
<br>
しかし、/usr/share/scripts/README.txt を開いたとき、それは ruby ファイルではあ<br>
りえませんよね。&quot;*&quot; で終わるパターンの問題は、多くのファイルにマッチしすぎてし<br>
まうことです。この問題を避けるには、<span class="MissingTag">'runtimepath'</span>&nbsp;の最後に指定されたディレクト<br>
リに &quot;filetype.vim&quot; を置きます。例えば Unix なら &quot;~/.vim/after/filetype.vim&quot;<br>
などです。<br>
では、~/.vim/filetype.vim にテキストファイルの検出を設定します:<br>
<br>
<div class="helpExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;augroup filetypedetect<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;au BufNewFile,BufRead *.txt&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; setf text<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;augroup END</div>
<br>
このファイルは&nbsp;<span class="MissingTag">'runtimepath'</span>&nbsp;の最初に見つかります。そして、最後に見つかるファ<br>
イル &quot;~/.vim/after/filetype.vim&quot; の中で次の設定をします:<br>
<br>
<div class="helpExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;augroup filetypedetect<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;au BufNewFile,BufRead /usr/share/scripts/*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setf ruby<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;augroup END</div>
<br>
処理の流れは次のようになります。Vim は&nbsp;<span class="MissingTag">'runtimepath'</span>&nbsp;の各ディレクトリから<br>
&quot;filetype.vim&quot; を探します。最初に &quot;~/.vim/filetype.vim&quot; が見つかります。*.txt<br>
を処理する自動コマンドがここで定義されます。次に Vim は $VIMRUNTIME にある<br>
filetype.vim を見つけます ($VIMRUNTIME は&nbsp;<span class="MissingTag">'runtimepath'</span>&nbsp;の中程にあります)。最<br>
後に ~/.vim/after/filetype.vim が見つかり、/usr/share/scripts の ruby ファイル<br>
を認識するための自動コマンドが追加されます。<br>
/usr/share/scripts/README.txt を開くと、定義された順番で自動コマンドがチェック<br>
されます。*.txt というパターンがマッチするので、&quot;setf text&quot; が実行され、ファイ<br>
ルタイプが &quot;text&quot; に設定されます。ruby 用のパターンもマッチするので、&quot;setf<br>
ruby&quot; が実行されます。しかし、<span class="MissingTag">'filetype'</span>&nbsp;は既に設定されているので何も起こりま<br>
せん。<br>
/usr/share/scripts/foobar を開くと、同様に自動コマンドがチェックされます。ruby<br>
のパターンだけがマッチするので、&quot;setf ruby&quot; が実行され、<span class="MissingTag">'filetype'</span>&nbsp;が ruby に<br>
設定されます。<br>
<br>
<br>
内容を見て判断する<br>
<span class="PreProc">------------------</span><br>
<br>
ファイル名からはファイル種別を判断できなくても、内容で判断できる場合がありま<br>
す。例えば、多くのスクリプトファイルは次のような行で始まります:<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="PreProc">#!/bin/xyz</span><br>
<br>
このスクリプトを認識するには、&quot;scripts.vim&quot; というファイルをランタイムディレク<br>
トリに作ります (filetype.vim と同じ場所です)。中身は次のようになります:<br>
<br>
<div class="helpExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if did_filetype()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;finish<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;endif<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if getline(1) =~ '^#!.*[/\\]xyz\&gt;'<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setf xyz<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;endif</div>
<br>
最初に did_filetype() を使って、既にファイル名からファイルタイプが認識されてい<br>
るかどうかを確認し、不要ならファイル内容のチェックを実行しないようにします。こ<br>
れは、&quot;setf&quot; コマンドが意味をなさないときに、ファイルのチェックによって時間を<br>
無駄に消費しないためです。<br>
scripts.vim は標準ファイルの filetype.vim で定義された自動コマンドによって読み<br>
込まれます。そのため、次の順番でチェックが実行されます:<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1.&nbsp;<span class="MissingTag">'runtimepath'</span>&nbsp;の $VIMRUNTIME の前にある filetype.vim<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2. $VIMRUNTIME/filetype.vim の前半部分<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.&nbsp;<span class="MissingTag">'runtimepath'</span>&nbsp;のすべての scripts.vim<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4. $VIMRUNTIME/filetype.vim の後半部分<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.&nbsp;<span class="MissingTag">'runtimepath'</span>&nbsp;の $VIMRUNTIME の後にある filetype.vim<br>
<br>
もっと複雑なことがしたい場合は、すべてのファイルにマッチする自動コマンドを追加<br>
して、スクリプトを読み込むなり関数を実行するなりしてファイルの内容をチェックし<br>
てください。<br>
<br>
<span class="PreProc">==============================================================================</span><br>
<br>
次章:&nbsp;<span class="MissingTag">usr_44.txt</span>&nbsp;&nbsp;構文ファイルを作成する<br>
<br>
Copyright: see&nbsp;<span class="MissingTag">manual-copyright</span>&nbsp;&nbsp;vim:tw=78:ts=8:ft=help:norl:<br>
</div>
